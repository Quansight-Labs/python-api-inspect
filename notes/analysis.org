* Python Inspect Analysis
   :PROPERTIES:
   :header-args: :db ../data/inspect.sqlite
   :END:

#+begin_src sqlite :exports both
SELECT count(DISTINCT filename) FROM FileStats
#+end_src

#+RESULTS:
: 420308

Number of files parsed 137k.

#+begin_src sqlite :exports both
SELECT count(DISTINCT namespace) FROM FileStats
#+end_src

#+RESULTS:
: 14137

5420 packages/namespaces found.

** Numpy analysis

#+begin_src sqlite :exports both
SELECT count(DISTINCT project) FROM FileStats WHERE namespace = "numpy"
#+end_src

#+RESULTS:
: 7841

There are 7841 packages that use ~numpy~ in the dataset.

#+NAME: calculate-stats
#+begin_src python
  import sqlite3
  import json
  import collections


  def calculate_stats(database_filename, filename, query):
      connection = sqlite3.connect(database_filename)
      with connection:
          functions = collections.defaultdict(int)

          stats = []
          for row in connection.execute(query):
              stats.append(json.loads(row[0]))
          stats = _join_stats(stats)

      print(f'{len(stats)} unique functions')
      _output_stats(stats, filename)


  def _join_stats(stats):
      total_stats = collections.defaultdict(lambda: {
          'count': 0,
          'n_args': collections.defaultdict(int),
          'kwargs': collections.defaultdict(int),
      })
      for stat in stats:
          for function in stat:
              total_stats[function]['count'] += stat[function]['count']
              for n_args, value in stat[function]['n_args'].items():
                    total_stats[function]['n_args'][n_args] += value
              for keyword, value in stat[function]['kwargs'].items():
                  total_stats[function]['kwargs'][keyword] += value
      return total_stats


  def _output_stats(stats, filename):
      print(f'writing {len(stats)} function calls to {filename:64}')
      with open(filename, 'w') as f:
          f.write('function, function_count, top_num_args, top_num_args_count, top_keyword, top_keyword_count\n')
          for key, value in sorted(stats.items(), key=lambda item: item[1]['count']):
              sorted_num_args = [(num_args, count) for num_args, count in sorted(stats[key]['n_args'].items(), key=lambda item: item[1], reverse=True)]

              sorted_keywords = [(keyword, count) for keyword, count in sorted(stats[key]['kwargs'].items(), key=lambda item: item[1], reverse=True)] + [('', '')]
              f.write(f'{key}, {value["count"]}, {sorted_num_args[0][0]}, {sorted_num_args[0][1]}, {sorted_keywords[0][0]}, {sorted_keywords[0][1]}\n')
#+end_src


#+begin_src python :noweb yes :var database_filename="../data/inspect.sqlite" :results output :exports both
  <<calculate-stats>>

  namespaces = [
    'astropy',
    'dask',
    ('ipython', 'IPython'),
    'ipywidgets',
    'matplotlib',
    'numpy',
    'pandas',
    'pyarrow',
    'pymapd',
    'pymc3',
    'pytorch',
    'requests',
    ('scikit-image', 'skimage'),
    ('scikit-learn', 'sklearn'),
    'scipy',
    'statsmodels',
    'sympy',
    'tensorflow',
    '__builtins__'
  ]

  QUERY_WITHOUT_SITEPACKAGES = '''
  SELECT stats
  FROM FileStats
  WHERE namespace = "{namespace}"
    AND filename NOT LIKE '%/site-packages/%'
  '''

  QUERY_WITHOUT_SITEPACKAGES_TESTS = '''
  SELECT stats
  FROM FileStats
  WHERE namespace = "{namespace}"
    AND filename NOT LIKE '%/site-packages/%'
    AND filename NOT LIKE '%/test/%'
    AND filename NOT LIKE '%/tests/%'
  '''

  QUERY_WITHOUT_SITEPACKAGES_ONLY_TESTS = '''
  SELECT stats
  FROM FileStats
  WHERE namespace = "{namespace}"
    AND filename NOT LIKE '%/site-packages/%'
    AND (filename LIKE '%/test/%' OR filename LIKE '%/tests/%')
  '''

  QUERY_WITHOUT_SITEPACKAGES_ONLY_NOTEBOOKS = '''
  SELECT stats
  FROM FileStats
  WHERE namespace = "{namespace}"
    AND filename NOT LIKE '%/site-packages/%'
    AND filename LIKE '%.ipynb'
  '''

  for namespace in namespaces:
      if isinstance(namespace, tuple):
          filename = namespace[0]
          namespace = namespace[1]
      else:
          filename = namespace
          namespace = namespace

      calculate_stats(database_filename,
                      f'../data/csv/{filename}-summary.csv',
                      QUERY_WITHOUT_SITEPACKAGES.format(namespace=namespace))
      calculate_stats(database_filename,
                      f'../data/csv/{filename}-summary-without-tests.csv',
                      QUERY_WITHOUT_SITEPACKAGES_TESTS.format(namespace=namespace))
      calculate_stats(database_filename,
                      f'../data/csv/{filename}-summary-tests.csv',
                      QUERY_WITHOUT_SITEPACKAGES_ONLY_TESTS.format(namespace=namespace))
      calculate_stats(database_filename,
                      f'../data/csv/{filename}-summary-notebooks.csv',
                      QUERY_WITHOUT_SITEPACKAGES_ONLY_NOTEBOOKS.format(namespace=namespace))
#+end_src

#+RESULTS:
#+begin_example
365 unique functions
writing 365 function calls to ../data/csv/astropy-summary.csv
348 unique functions
writing 348 function calls to ../data/csv/astropy-summary-without-tests.csv
75 unique functions
writing 75 function calls to ../data/csv/astropy-summary-tests.csv
39 unique functions
writing 39 function calls to ../data/csv/astropy-summary-notebooks.csv
283 unique functions
writing 283 function calls to ../data/csv/dask-summary.csv
172 unique functions
writing 172 function calls to ../data/csv/dask-summary-without-tests.csv
199 unique functions
writing 199 function calls to ../data/csv/dask-summary-tests.csv
44 unique functions
writing 44 function calls to ../data/csv/dask-summary-notebooks.csv
92 unique functions
writing 92 function calls to ../data/csv/ipython-summary.csv
85 unique functions
writing 85 function calls to ../data/csv/ipython-summary-without-tests.csv
11 unique functions
writing 11 function calls to ../data/csv/ipython-summary-tests.csv
9 unique functions
writing 9 function calls to ../data/csv/ipython-summary-notebooks.csv
82 unique functions
writing 82 function calls to ../data/csv/ipywidgets-summary.csv
79 unique functions
writing 79 function calls to ../data/csv/ipywidgets-summary-without-tests.csv
8 unique functions
writing 8 function calls to ../data/csv/ipywidgets-summary-tests.csv
54 unique functions
writing 54 function calls to ../data/csv/ipywidgets-summary-notebooks.csv
1009 unique functions
writing 1009 function calls to ../data/csv/matplotlib-summary.csv
934 unique functions
writing 934 function calls to ../data/csv/matplotlib-summary-without-tests.csv
375 unique functions
writing 375 function calls to ../data/csv/matplotlib-summary-tests.csv
291 unique functions
writing 291 function calls to ../data/csv/matplotlib-summary-notebooks.csv
1499 unique functions
writing 1499 function calls to ../data/csv/numpy-summary.csv
1278 unique functions
writing 1278 function calls to ../data/csv/numpy-summary-without-tests.csv
890 unique functions
writing 890 function calls to ../data/csv/numpy-summary-tests.csv
483 unique functions
writing 483 function calls to ../data/csv/numpy-summary-notebooks.csv
1603 unique functions
writing 1603 function calls to ../data/csv/pandas-summary.csv
1102 unique functions
writing 1102 function calls to ../data/csv/pandas-summary-without-tests.csv
817 unique functions
writing 817 function calls to ../data/csv/pandas-summary-tests.csv
158 unique functions
writing 158 function calls to ../data/csv/pandas-summary-notebooks.csv
209 unique functions
writing 209 function calls to ../data/csv/pyarrow-summary.csv
124 unique functions
writing 124 function calls to ../data/csv/pyarrow-summary-without-tests.csv
173 unique functions
writing 173 function calls to ../data/csv/pyarrow-summary-tests.csv
8 unique functions
writing 8 function calls to ../data/csv/pyarrow-summary-notebooks.csv
1 unique functions
writing 1 function calls to ../data/csv/pymapd-summary.csv
1 unique functions
writing 1 function calls to ../data/csv/pymapd-summary-without-tests.csv
0 unique functions
writing 0 function calls to ../data/csv/pymapd-summary-tests.csv
1 unique functions
writing 1 function calls to ../data/csv/pymapd-summary-notebooks.csv
268 unique functions
writing 268 function calls to ../data/csv/pymc3-summary.csv
229 unique functions
writing 229 function calls to ../data/csv/pymc3-summary-without-tests.csv
132 unique functions
writing 132 function calls to ../data/csv/pymc3-summary-tests.csv
173 unique functions
writing 173 function calls to ../data/csv/pymc3-summary-notebooks.csv
1 unique functions
writing 1 function calls to ../data/csv/pytorch-summary.csv
1 unique functions
writing 1 function calls to ../data/csv/pytorch-summary-without-tests.csv
0 unique functions
writing 0 function calls to ../data/csv/pytorch-summary-tests.csv
0 unique functions
writing 0 function calls to ../data/csv/pytorch-summary-notebooks.csv
106 unique functions
writing 106 function calls to ../data/csv/requests-summary.csv
77 unique functions
writing 77 function calls to ../data/csv/requests-summary-without-tests.csv
59 unique functions
writing 59 function calls to ../data/csv/requests-summary-tests.csv
9 unique functions
writing 9 function calls to ../data/csv/requests-summary-notebooks.csv
232 unique functions
writing 232 function calls to ../data/csv/scikit-image-summary.csv
179 unique functions
writing 179 function calls to ../data/csv/scikit-image-summary-without-tests.csv
108 unique functions
writing 108 function calls to ../data/csv/scikit-image-summary-tests.csv
44 unique functions
writing 44 function calls to ../data/csv/scikit-image-summary-notebooks.csv
364 unique functions
writing 364 function calls to ../data/csv/scikit-learn-summary.csv
291 unique functions
writing 291 function calls to ../data/csv/scikit-learn-summary-without-tests.csv
199 unique functions
writing 199 function calls to ../data/csv/scikit-learn-summary-tests.csv
115 unique functions
writing 115 function calls to ../data/csv/scikit-learn-summary-notebooks.csv
1793 unique functions
writing 1793 function calls to ../data/csv/scipy-summary.csv
1344 unique functions
writing 1344 function calls to ../data/csv/scipy-summary-without-tests.csv
929 unique functions
writing 929 function calls to ../data/csv/scipy-summary-tests.csv
345 unique functions
writing 345 function calls to ../data/csv/scipy-summary-notebooks.csv
158 unique functions
writing 158 function calls to ../data/csv/statsmodels-summary.csv
145 unique functions
writing 145 function calls to ../data/csv/statsmodels-summary-without-tests.csv
25 unique functions
writing 25 function calls to ../data/csv/statsmodels-summary-tests.csv
75 unique functions
writing 75 function calls to ../data/csv/statsmodels-summary-notebooks.csv
300 unique functions
writing 300 function calls to ../data/csv/sympy-summary.csv
280 unique functions
writing 280 function calls to ../data/csv/sympy-summary-without-tests.csv
86 unique functions
writing 86 function calls to ../data/csv/sympy-summary-tests.csv
107 unique functions
writing 107 function calls to ../data/csv/sympy-summary-notebooks.csv
3147 unique functions
writing 3147 function calls to ../data/csv/tensorflow-summary.csv
3090 unique functions
writing 3090 function calls to ../data/csv/tensorflow-summary-without-tests.csv
525 unique functions
writing 525 function calls to ../data/csv/tensorflow-summary-tests.csv
575 unique functions
writing 575 function calls to ../data/csv/tensorflow-summary-notebooks.csv
67 unique functions
writing 67 function calls to ../data/csv/__builtins__-summary.csv
67 unique functions
writing 67 function calls to ../data/csv/__builtins__-summary-without-tests.csv
66 unique functions
writing 66 function calls to ../data/csv/__builtins__-summary-tests.csv
63 unique functions
writing 63 function calls to ../data/csv/__builtins__-summary-notebooks.csv
#+end_example
